<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>सूर्यसिद्धान्तीय पञ्चाङ्गम् </title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body{margin-left: 25%; margin-right: 25%; text-align: center; font-size: larger; font-family:Arial,Helvetica,sans-serif;margin:30px;background:#f5f7fa;align-content: center;font-weight: bolder;}
  input,select,button{margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:6px;}
  button{background:#007bff;color:#fff;cursor:pointer;}
  button:hover{background:#0056b3;}
  #result{background:#fff;border-radius:10px;padding:20px;margin-top:20px;
          box-shadow:0 0 10px rgba(0,0,0,0.1);}
  b{color:#007bff;}
</style>
<style>
  /* Initially hide the div */
  #dwivediJi {
    display: none;
    padding: 20px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    margin-top: 10px;
    border-radius: 8px;
  }
</style>
</head>
<body style="margin-left: 20%; margin-right: 20%;">

<h1 style="text-align: center; font-size: larger;">सूर्यसिद्धान्तीय पञ्चाङ्गम् </h1>

<label></label><br>
<input type="file" id="excelFile" style="font-size:xx-small; display: none;" accept=".xlsx,.xls" /><br>

<select id="fileLink">
  <option value="">स्थान चुनें</option>
  <option value="https://dl.dropboxusercontent.com/scl/fi/f0wbxmv8o980slrf9tu78/kashi2026.xlsx?rlkey=rcg3wqkgtr5h96eagaq9lrhsr&st=xq1ufzsd">
    काशी
  </option>
  <option value="https://dl.dropboxusercontent.com/scl/fi/foystnbeaarsjoe2wth6d/.xlsx?rlkey=mm9i9gecfwtyacn2s4cfsnicx&st=nfm45zkt&st=kqv17s3q">
    जयपुर
  </option>
</select><br><br>

<button onclick="loadFile()">पुष्टि करें</button><br><br>

<div id="dateSection" style="display:none; text-align: center;">
  <label style="font-size: larger;">आङ्ग्ल दिनाङ्क चुनें</label><br>
  <input type="date" style="font-size: larger;" id="datePicker" /><br><br>
  <button onclick="searchData()" style="font-size: larger;">पञ्चाङ्ग</button>
</div>

<h3 style="text-align: center; font-size: larger;">चयनित दिनाङ्क का पञ्चाङ्ग</h3>
<div id="result" style="text-align: center; font-size: larger;"></div>
<p> <span id="test"></span> </p>


<script>
let workbookData = null;

// Convert Excel serial or date-like string → dd/mm/yyyy
function normalizeDate(v){
  if(!v) return "";
  if(!isNaN(v)){
    const base=new Date(Date.UTC(1899,11,30));
    base.setDate(base.getDate()+Number(v));
    return base.toLocaleDateString("en-GB");
  }
  const d=new Date(v);
  if(!isNaN(d)) return d.toLocaleDateString("en-GB");
  return v.toString().trim();
}

// Convert Excel decimal → HH:MM:SS (supports >24 hrs)
function excelTimeToHMS(value){
  if(isNaN(value)) return value;
  const totalSec=Math.round(value*24*3600);
  const h=Math.floor(totalSec/3600);
  const m=Math.floor((totalSec%3600)/60);
  const s=totalSec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

// Load Excel file
async function loadFile(){
  const file=document.getElementById("excelFile").files[0];
  const link=document.getElementById("fileLink").value.trim();
  const resDiv=document.getElementById("result");
  resDiv.innerHTML="⏳ गणना हो रही है.....";

  try{
    let buffer;
    if(file){
      buffer=await file.arrayBuffer();
    }else if(link){
      const resp=await fetch(link);
      if(!resp.ok) throw new Error("Cannot load file");
      buffer=await resp.arrayBuffer();
    }else{
      resDiv.innerHTML="⚠️ कृपया पहले स्थान चुनें";
      return;
    }

    const wb=XLSX.read(new Uint8Array(buffer),{type:"array"});
    const sh=wb.Sheets[wb.SheetNames[0]];
    workbookData=XLSX.utils.sheet_to_json(sh,{header:1,raw:true,defval:""});
    document.getElementById("dateSection").style.display="block";
    resDiv.innerHTML="✅ कृपया आङ्ग्ल दिनाङ्क चुनें";
  }catch(err){
    console.error(err);
    resDiv.innerHTML="❌ गणना करने में त्रुटि हो रही है";
  }
}

// Search data for selected date
function searchData(){
  if(!workbookData){document.getElementById("result").innerHTML="⚠️ Load a file first.";return;}
  const picker=document.getElementById("datePicker");
  if(!picker.value){document.getElementById("result").innerHTML="⚠️ Please select a date.";return;}
  const selectedDate=new Date(picker.value).toLocaleDateString("en-GB");
  const headers=workbookData[0];
  const row=workbookData.find((r,i)=>i>0 && normalizeDate(r[0])===selectedDate);
  const resDiv=document.getElementById("result");

  if(!row){resDiv.innerHTML="❌ दिनाङ्क "+selectedDate+"उपलब्ध नहीं है";return;}

  let out=`<b>Date:</b> ${selectedDate}<br><br>`;
  for(let i=1;i<headers.length;i++){
    const name=headers[i];
    let val=row[i];
//Roman to Devnagri mapping word by word:
  const dayMap = { Sun:"रविवार", Mon:"सोमवार", Tue:"मङ्गलवार", Wed:"बुधवार", Thu:"बृहस्पतिवार", Fri:"शुक्रवार", Sat:"शनिवार" };
  if(i === 2 && dayMap[val]) 
    val = dayMap[val];
  // nakshatra name mapping (if col2 has Sun/Mon etc.)
  const nakshatraMap = { "1-Ashvini": "अश्विनी", "2-Bharani": "भरणी", "3-Krittikä": "कृत्तिका", "5-Mrigshirä": "रोहिणी", "6-Ärdrä": "मृगशिरा", "7-Punarvasu": "आर्द्रा", "8-Pušya": "पुनर्वसु", "9-Äshlešä": "पुष्य", "10-Maghä": "अश्लेषा", "11-1Phälguni": "मघा", "12-2Phälguni": "पूर्वाफाल्गुनी", "13-Hasta": "उत्तराफाल्गुनी", "14-Chiträ": "हस्त", "15-Sväti": "चित्रा", "15-Sväti": "स्वाती", "16-Vishäkhä": "विशाखा", "17-Anurädhä": "अनुराधा", "18-Jyešthä": "ज्येष्ठा", "19-Moola": "मुल", "20-1Äšädha": "पुर्वाषाढा", "21-2Äšädha": "उत्तरषाढा", "22-Shravana": "श्रवण", "23-Dhaništhä": "धनिष्ठा", "24-Shatbhiš": "शतभिषा", "25-1Bhädrpad": "पूर्वभाद्रपद", "26-2Bhädrpad": "उत्तरभाद्रपद", "27-Revati": "रेवती" };
  if(i === 16 && nakshatraMap[val]) 
    val = nakshatraMap[val];

  // yog name mapping (if col5 has 01:Viškambh etc.)
  const yogMap = { "01:Viškambh": "विष्कुम्भ", "02:Preeti": "प्रीति", "03:Ayušmän": "आयुष्मान", "04:Saubhägy": "सौभाग्य", "05:Shobhan": "शोभन", "06:Atigand": "अतिगण्ड", "07:Sukarman": "सुकर्मा", "08:Dhriti": "धृति", "09:Shoola": "शूल", "10:Ganda": "गण्ड", "11:Vriddhi": "वृद्धि", "12:Dhruva": "ध्रुव", "13:Vyäghät": "व्याघात", "14:Haršan": "हर्षण", "15:Vajra": "वज्र", "16:Siddhi": "सिद्धि", "17:Vyatipät": "व्यतीपात", "18:Variyän": "वरीयान्", "19:Parigha": "परिघ", "20:Shiva": "शिव", "21:Siddha": "सिद्ध", "22:Sädhy": "साध्य", "23:Shubha": "शुभ", "24:Shukla": "शुक्ल", "25:Brahma": "ब्रह्म", "26:Indra": "इन्द्र", "27:Vædhrti": "वैधृति"};
  if(i === 5 && yogMap[val]) 
  val = yogMap[val];

 // day name mapping (if col2 has Sun/Mon etc.)
  const karanMap = { "Bava": "बव", "Bälav": "बालव", "Kaulav": "कौलव", "Taitil": "तैतिल", "Gara": "गर", "Vanij": "वणिज", "Višti": "विष्टि *(भद्रा)*", "Shakun": "शकुनि", "Chatuš": "चतुष्पाद", "Näga": "नाग", "Kimstu": "किस्तुघ्न" };
  if(i === 7 && karanMap[val]) 
  val = karanMap[val];


//Roman to Devnagri mapping samapta

    // ✅ Step 1: Check if this is column 13 (index 12)
  if (i === 13 && String(val).trim() === "0") {
    val = "अहोरात्र"; // Replace directly
  }

  // ✅ Step 2: Handle time formatting logic for other columns
  else

    if(typeof val==="string" && /^\d{2,}:\d{2}(:\d{2})?$/.test(val.trim())){
      // Already formatted time
    }else if(!isNaN(val)&&val!==""){
      const num=parseFloat(val);
      if(num>=0 && num<2 && i !== 3) val=excelTimeToHMS(num);
    }


   // const varName=name.replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_]/g,"");
    const varName = "col"+i;
    window[varName]=val;

    
    out+=`<b>${name}:</b> <span id="${varName}">${val}</span><br>`;
    document.getElementById("test").innerText = window.col3;
   // document.getElementById("gcCtrl").style.display= "block";
   // document.getElementById("gcWrap").style.display= "block";

  }
  
  resDiv.innerHTML=out;
}
</script>


<!-- =================== GRAHA CHAKRA ENHANCER (FULL PATCH) =================== -->
<style>
  #gc_container{display:none;margin-top:20px;padding:12px;border-radius:10px;
    background:#f9e0a6;border:1px solid #e0b86a;}
  #gc_controls{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  #gc_canvas_wrap{position:relative}
  #gc_canvas{width:100%;height:auto;display:block;background:transparent}
  #gc_tooltip{
    position:absolute;pointer-events:none;display:none;
    background:rgba(0,0,0,0.85);color:#fff;padding:6px 9px;
    border-radius:6px;font-size:13px;z-index:9999;
  }
  .gc_btn{
    padding:6px 10px;border:0;border-radius:6px;
    background:#7b3f00;color:#fff;cursor:pointer;
  }
  .gc_sel{padding:6px;border-radius:6px}
</style>

<div id="gc_container">
  <div id="gc_controls">
    <select id="gc_style" class="gc_sel">
      <option value="south">South Wheel</option>
      <option value="north">North Box</option>
    </select>
    <button id="gc_export" class="gc_btn">Export PNG</button>
    <button id="gc_hide" class="gc_btn">Hide Chart</button>
  </div>
  <div id="gc_canvas_wrap">
    <canvas id="gc_canvas" width="900" height="900"></canvas>
    <div id="gc_tooltip"></div>
  </div>
</div>

<script>
(function(){

/* ------------------- CONSTANTS ------------------- */
const RASHI = ['मेष','वृषभ','मिथुन','कर्क','सिंह','कन्या','तुला','वृश्चिक','धनु','मकर','कुम्भ','मीन'];
const HOUSE_ROMAN = ['I','II','III','IV','V','VI','VII','VIII','IX','X','XI','XII'];

const RCOL = [
  '#9bd56b','#7bd2d5','#6ea6ff','#6a4bff',
  '#ff8a65','#c48bcb','#81c784','#4db6ac',
  '#64b5f6','#4fc3f7','#aed581','#ffb74d'
];

const PLANETS = [
  {label:'सूर्य', col:17, glyph:'☉', color:'#ff5722'},
  {label:'चन्द्र', col:18, glyph:'☽', color:'#90caf9'},
  {label:'मंगल',  col:19, glyph:'♂', color:'#e57373'},
  {label:'बुध',   col:20, glyph:'☿', color:'#8bc34a'},
  {label:'गुरु',  col:21, glyph:'♃', color:'#ffeb3b'},
  {label:'शुक्र', col:22, glyph:'♀', color:'#f06292'},
  {label:'शनि',  col:23, glyph:'♄', color:'#455a64'},
  {label:'राहु', col:24, glyph:'☊', color:'#6a1b9a'}
];

/* ------------------- ELEMENTS ------------------- */
const container = document.getElementById("gc_container");
const canvas    = document.getElementById("gc_canvas");
const tooltip   = document.getElementById("gc_tooltip");
let ctx, SIZE;

/* ------------------- HELPERS ------------------- */
function resizeGC(){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  SIZE = Math.min(rect.width || 700, 900);
  canvas.width  = SIZE * dpr;
  canvas.height = SIZE * dpr;
  canvas.style.height = SIZE + "px";
  ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
}

function formatDeg(d){
  if(isNaN(d)) return "";
  d = ((d%360)+360)%360;
  let D = Math.floor(d);
  let M = Math.floor((d-D)*60);
  return D+"°"+(M?M+"′":"");
}

/*  SPECIAL: col17 & col18 have sector-degree-minute-second
    01:14°30'30 → sector*30 + (deg + min/60 + sec/3600)
*/
function parseSectorAngle(str){
  if(!str) return NaN;
  str = String(str).trim();
  if(str.includes(":") && str.includes("°")){
    let [sector, rest] = str.split(":");
    let [degPart, rem] = rest.split("°");
    let min = rem.split("'")[0];
    let sec = rem.split("'")[1] || "0";
    let s = parseFloat(sector)||0;
    let d = parseFloat(degPart)||0;
    let m = parseFloat(min)||0;
    let sc = parseFloat(sec.replace(/[^0-9.]/g,''))||0;
    return s*30 + d + (m/60) + (sc/3600);
  }
  return NaN;
}

/* general D°M'S'' parser */
function parseAngle(str, isSec){
  if(!str) return NaN;
  str = String(str).trim();
  if(isSec){
    let v = parseSectorAngle(str);
    if(!isNaN(v)) return v;
  }
  if(str.includes("°")){
    let [d, rest] = str.split("°");
    let m = 0, s = 0;
    if(rest){
      m = parseFloat((rest.split("'")[0])||0)||0;
      s = parseFloat((rest.split("'")[1]||"").replace(/[^0-9.]/g,''))||0;
    }
    return (parseFloat(d)||0) + m/60 + s/3600;
  }
  let num = parseFloat(str.replace(/[^0-9.-]/g,''));
  return isNaN(num) ? NaN : num;
}

/* ------------------- DRAW WHEEL ------------------- */
function drawWheel(){
  resizeGC();
  ctx.clearRect(0,0,SIZE,SIZE);
  const cx = SIZE/2, cy = SIZE/2, R = SIZE*0.42;

  /* 12 rāśi sectors */
  for(let i=0;i<12;i++){
    let a1 = (i*30 - 90)*Math.PI/180;
    let a2 = ((i+1)*30 - 90)*Math.PI/180;

    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,R,a1,a2);
    ctx.closePath();
    ctx.fillStyle = RCOL[i]+"55";
    ctx.fill();
    ctx.strokeStyle="#6b3e18";
    ctx.lineWidth=1.2;
    ctx.stroke();

    /* label */
    let mid = (a1+a2)/2;
    ctx.font=(SIZE*0.030)+"px Arial";
    ctx.fillStyle="#5a2a0a";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(RASHI[i], cx+(R+SIZE*0.06)*Math.cos(mid), cy+(R+SIZE*0.06)*Math.sin(mid));

    /* Roman house number */
    ctx.font=(SIZE*0.025)+"px Arial";
    ctx.fillText(HOUSE_ROMAN[i], cx+(R+SIZE*0.11)*Math.cos(mid), cy+(R+SIZE*0.11)*Math.sin(mid));
  }

  /* 27 Nakshatra rays */
  for(let k=0;k<27;k++){
    let ang=(k*(360/27)-90)*Math.PI/180;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R*Math.cos(ang), cy+R*Math.sin(ang));
    ctx.strokeStyle="rgba(80,40,10,0.13)";
    ctx.lineWidth=1;
    ctx.stroke();
  }

  /* Planets */
  PLANETS.forEach(p=>{
    const raw = window["col"+p.col];
    const deg = parseAngle(raw, (p.col===17||p.col===18));
    if(isNaN(deg)){ p._pos=null; return; }

    let rad=(deg-90)*Math.PI/180;
    let px=cx+R*Math.cos(rad);
    let py=cy+R*Math.sin(rad);

    /* ray */
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(px,py);
    ctx.strokeStyle="rgba(100,50,20,0.25)";
    ctx.lineWidth=1;
    ctx.stroke();

    /* planet icon circle */
    ctx.beginPath();
    ctx.fillStyle=p.color;
    ctx.arc(px,py,SIZE*0.02,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle="#fff";
    ctx.stroke();

    /* glyph */
    ctx.font=(SIZE*0.030)+"px Arial";
    ctx.fillStyle="#fff";
    ctx.textAlign="center";
    ctx.textBaseline="middle";
    ctx.fillText(p.glyph, px, py);

    /* Devnagari name */
    ctx.font=(SIZE*0.025)+"px Arial";
    ctx.fillStyle="#402000";
    ctx.textAlign="left";
    ctx.fillText(p.label+" "+formatDeg(deg), px+SIZE*0.03, py);

    p._pos={x:px,y:py,deg};
  });
}

function drawNorth(){ drawWheel(); } // fallback

function renderGC(){
  const style=document.getElementById("gc_style").value;
  if(style==='north') drawNorth();
  else drawWheel();
}

/* ------------------- TOOLTIP ------------------- */
canvas.addEventListener('mousemove', ev=>{
  const rect=canvas.getBoundingClientRect();
  const x=ev.clientX-rect.left, y=ev.clientY-rect.top;
  let best=null, dmin=1e9;
  PLANETS.forEach(p=>{
    if(!p._pos) return;
    let dx=p._pos.x-x, dy=p._pos.y-y;
    let d=Math.hypot(dx,dy);
    if(d<dmin){ dmin=d; best=p; }
  });
  if(best && dmin<SIZE*0.035){
    tooltip.style.display='block';
    tooltip.style.left = (ev.pageX+12)+"px";
    tooltip.style.top  = (ev.pageY+12)+"px";
    let r = Math.floor(((best._pos.deg%360)+360)%360 /30);
    tooltip.innerHTML = "<b>"+best.label+"</b><br>"+formatDeg(best._pos.deg)+"<br>राशि: "+RASHI[r];
  }else{
    tooltip.style.display='none';
  }
});

/* ------------------- HOOK INTO searchData ------------------- */
function hookSearch(){
  if(typeof window.searchData==="function" && !window.__gc_hooked){
    const old=window.searchData;
    window.searchData=function(){
      let r = old.apply(this, arguments);
      container.style.display="block";
      setTimeout(renderGC,80);
      return r;
    };
    window.__gc_hooked=true;
  }else if(!window.__gc_hooked){
    setTimeout(hookSearch,200);
  }
}
hookSearch();

/* ------------------- CONTROLS ------------------- */
document.getElementById("gc_style").addEventListener("change", renderGC);
document.getElementById("gc_export").addEventListener("click", ()=>{
  const url=canvas.toDataURL("image/png");
  const a=document.createElement("a");
  a.href=url; a.download="graha_chakra.png"; a.click();
});
document.getElementById("gc_hide").addEventListener("click",()=>{container.style.display="none";});

/* initial attempt */
setTimeout(()=>{try{renderGC();}catch(e){}},500);

})();
</script>
<!-- ================= END GRAHA CHAKRA ENHANCER ================= -->



</body>
</html>
