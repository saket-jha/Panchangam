<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§∏‡§ø‡§¶‡•ç‡§ß‡§æ‡§®‡•ç‡§§‡•Ä‡§Ø ‡§™‡§û‡•ç‡§ö‡§æ‡§ô‡•ç‡§ó‡§Æ‡•ç </title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body{margin-left: 25%; margin-right: 25%; text-align: center; font-size: larger; font-family:Arial,Helvetica,sans-serif;margin:30px;background:#f5f7fa;align-content: center;font-weight: bolder;}
  input,select,button{margin:6px 0;padding:8px;border:1px solid #ccc;border-radius:6px;}
  button{background:#007bff;color:#fff;cursor:pointer;}
  button:hover{background:#0056b3;}
  #result{background:#fff;border-radius:10px;padding:20px;margin-top:20px;
          box-shadow:0 0 10px rgba(0,0,0,0.1);}
  b{color:#007bff;}
</style>
<style>
  /* Initially hide the div */
  #dwivediJi {
    display: none;
    padding: 20px;
    background-color: #f0f0f0;
    border: 1px solid #ccc;
    margin-top: 10px;
    border-radius: 8px;
  }
</style>
</head>
<body style="margin-left: 20%; margin-right: 20%;">

<h1 style="text-align: center; font-size: larger;">‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§∏‡§ø‡§¶‡•ç‡§ß‡§æ‡§®‡•ç‡§§‡•Ä‡§Ø ‡§™‡§û‡•ç‡§ö‡§æ‡§ô‡•ç‡§ó‡§Æ‡•ç </h1>

<label></label><br>
<input type="file" id="excelFile" style="font-size:xx-small; display: none;" accept=".xlsx,.xls" /><br>

<select id="fileLink">
  <option value="">‡§∏‡•ç‡§•‡§æ‡§® ‡§ö‡•Å‡§®‡•á‡§Ç</option>
  <option value="saket-jha.github.io/Panchangam/kashi2026.xlsx">
    ‡§ï‡§æ‡§∂‡•Ä
  </option>
  <option value="https://dl.dropboxusercontent.com/scl/fi/foystnbeaarsjoe2wth6d/.xlsx?rlkey=mm9i9gecfwtyacn2s4cfsnicx&st=nfm45zkt&st=kqv17s3q">
    ‡§ú‡§Ø‡§™‡•Å‡§∞
  </option>
</select><br><br>

<button onclick="loadFile()">‡§™‡•Å‡§∑‡•ç‡§ü‡§ø ‡§ï‡§∞‡•á‡§Ç</button><br><br>

<div id="dateSection" style="display:none; text-align: center;">
  <label style="font-size: larger;">‡§Ü‡§ô‡•ç‡§ó‡•ç‡§≤ ‡§¶‡§ø‡§®‡§æ‡§ô‡•ç‡§ï ‡§ö‡•Å‡§®‡•á‡§Ç</label><br>
  <input type="date" style="font-size: larger;" id="datePicker" /><br><br>
  <button onclick="searchData()" style="font-size: larger;">‡§™‡§û‡•ç‡§ö‡§æ‡§ô‡•ç‡§ó</button>
</div>

<h3 style="text-align: center; font-size: larger;">‡§ö‡§Ø‡§®‡§ø‡§§ ‡§¶‡§ø‡§®‡§æ‡§ô‡•ç‡§ï ‡§ï‡§æ ‡§™‡§û‡•ç‡§ö‡§æ‡§ô‡•ç‡§ó</h3>
<div id="result" style="text-align: center; font-size: larger;"></div>
<p> <span id="test"></span> </p>


<script>
let workbookData = null;

// Convert Excel serial or date-like string ‚Üí dd/mm/yyyy
function normalizeDate(v){
  if(!v) return "";
  if(!isNaN(v)){
    const base=new Date(Date.UTC(1899,11,30));
    base.setDate(base.getDate()+Number(v));
    return base.toLocaleDateString("en-GB");
  }
  const d=new Date(v);
  if(!isNaN(d)) return d.toLocaleDateString("en-GB");
  return v.toString().trim();
}

// Convert Excel decimal ‚Üí HH:MM:SS (supports >24 hrs)
function excelTimeToHMS(value){
  if(isNaN(value)) return value;
  const totalSec=Math.round(value*24*3600);
  const h=Math.floor(totalSec/3600);
  const m=Math.floor((totalSec%3600)/60);
  const s=totalSec%60;
  return `${h.toString().padStart(2,"0")}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}

// Load Excel file
async function loadFile() {

  const link = document.getElementById("fileLink").value;
  const resDiv = document.getElementById("result");

  if (!link) {
    resDiv.innerHTML = "‚ö†Ô∏è ‡§ï‡•É‡§™‡§Ø‡§æ ‡§™‡§π‡§≤‡•á ‡§∏‡•ç‡§•‡§æ‡§® ‡§ö‡•Å‡§®‡•á‡§Ç";
    return;
  }

  resDiv.innerHTML = "‚è≥ ‡§´‡§º‡§æ‡§á‡§≤ ‡§≤‡•ã‡§° ‡§π‡•ã ‡§∞‡§π‡•Ä ‡§π‡•à...";

  try {
    // üî• Directly load local XLSX file from same folder
    const resp = await fetch(link);

    if (!resp.ok) {
      throw new Error("‡§´‡§º‡§æ‡§á‡§≤ ‡§®‡§π‡•Ä‡§Ç ‡§Æ‡§ø‡§≤‡•Ä: " + link);
    }

    const buffer = await resp.arrayBuffer();

    const wb = XLSX.read(new Uint8Array(buffer), { type: "array" });
    const sheet = wb.Sheets[wb.SheetNames[0]];

    workbookData = XLSX.utils.sheet_to_json(sheet, {
      header: 1,
      raw: true,
      defval: ""
    });

    document.getElementById("dateSection").style.display = "block";
    resDiv.innerHTML = "‚úÖ ‡§ó‡§£‡§®‡§æ ‡§π‡•á‡§§‡•Å ‡§¶‡§ø‡§®‡§æ‡§Ç‡§ï ‡§ö‡•Å‡§®‡•á‡§Ç";

  } catch (err) {
    console.error(err);
    resDiv.innerHTML = "‚ùå ‡§§‡•ç‡§∞‡•Å‡§ü‡§ø: " + err.message;
  }
}

// Search data for selected date
function searchData(){
  if(!workbookData){document.getElementById("result").innerHTML="‚ö†Ô∏è Load a file first.";return;}
  const picker=document.getElementById("datePicker");
  if(!picker.value){document.getElementById("result").innerHTML="‚ö†Ô∏è Please select a date.";return;}
  const selectedDate=new Date(picker.value).toLocaleDateString("en-GB");
  const headers=workbookData[0];
  const row=workbookData.find((r,i)=>i>0 && normalizeDate(r[0])===selectedDate);
  const resDiv=document.getElementById("result");

  if(!row){resDiv.innerHTML="‚ùå ‡§¶‡§ø‡§®‡§æ‡§ô‡•ç‡§ï "+selectedDate+"‡§â‡§™‡§≤‡§¨‡•ç‡§ß ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à";return;}

  let out=`<b>Date:</b> ${selectedDate}<br><br>`;
  for(let i=1;i<headers.length;i++){
    const name=headers[i];
    let val=row[i];
//Roman to Devnagri mapping word by word:
  const dayMap = { Sun:"‡§∞‡§µ‡§ø‡§µ‡§æ‡§∞", Mon:"‡§∏‡•ã‡§Æ‡§µ‡§æ‡§∞", Tue:"‡§Æ‡§ô‡•ç‡§ó‡§≤‡§µ‡§æ‡§∞", Wed:"‡§¨‡•Å‡§ß‡§µ‡§æ‡§∞", Thu:"‡§¨‡•É‡§π‡§∏‡•ç‡§™‡§§‡§ø‡§µ‡§æ‡§∞", Fri:"‡§∂‡•Å‡§ï‡•ç‡§∞‡§µ‡§æ‡§∞", Sat:"‡§∂‡§®‡§ø‡§µ‡§æ‡§∞" };
  if(i === 2 && dayMap[val]) 
    val = dayMap[val];
  // nakshatra name mapping (if col2 has Sun/Mon etc.)
  const nakshatraMap = { "1-Ashvini": "‡§Ö‡§∂‡•ç‡§µ‡§ø‡§®‡•Ä", "2-Bharani": "‡§≠‡§∞‡§£‡•Ä", "3-Krittik√§": "‡§ï‡•É‡§§‡•ç‡§§‡§ø‡§ï‡§æ", "5-Mrigshir√§": "‡§∞‡•ã‡§π‡§ø‡§£‡•Ä", "6-√Ñrdr√§": "‡§Æ‡•É‡§ó‡§∂‡§ø‡§∞‡§æ", "7-Punarvasu": "‡§Ü‡§∞‡•ç‡§¶‡•ç‡§∞‡§æ", "8-Pu≈°ya": "‡§™‡•Å‡§®‡§∞‡•ç‡§µ‡§∏‡•Å", "9-√Ñshle≈°√§": "‡§™‡•Å‡§∑‡•ç‡§Ø", "10-Magh√§": "‡§Ö‡§∂‡•ç‡§≤‡•á‡§∑‡§æ", "11-1Ph√§lguni": "‡§Æ‡§ò‡§æ", "12-2Ph√§lguni": "‡§™‡•Ç‡§∞‡•ç‡§µ‡§æ‡§´‡§æ‡§≤‡•ç‡§ó‡•Å‡§®‡•Ä", "13-Hasta": "‡§â‡§§‡•ç‡§§‡§∞‡§æ‡§´‡§æ‡§≤‡•ç‡§ó‡•Å‡§®‡•Ä", "14-Chitr√§": "‡§π‡§∏‡•ç‡§§", "15-Sv√§ti": "‡§ö‡§ø‡§§‡•ç‡§∞‡§æ", "15-Sv√§ti": "‡§∏‡•ç‡§µ‡§æ‡§§‡•Ä", "16-Vish√§kh√§": "‡§µ‡§ø‡§∂‡§æ‡§ñ‡§æ", "17-Anur√§dh√§": "‡§Ö‡§®‡•Å‡§∞‡§æ‡§ß‡§æ", "18-Jye≈°th√§": "‡§ú‡•ç‡§Ø‡•á‡§∑‡•ç‡§†‡§æ", "19-Moola": "‡§Æ‡•Å‡§≤", "20-1√Ñ≈°√§dha": "‡§™‡•Å‡§∞‡•ç‡§µ‡§æ‡§∑‡§æ‡§¢‡§æ", "21-2√Ñ≈°√§dha": "‡§â‡§§‡•ç‡§§‡§∞‡§∑‡§æ‡§¢‡§æ", "22-Shravana": "‡§∂‡•ç‡§∞‡§µ‡§£", "23-Dhani≈°th√§": "‡§ß‡§®‡§ø‡§∑‡•ç‡§†‡§æ", "24-Shatbhi≈°": "‡§∂‡§§‡§≠‡§ø‡§∑‡§æ", "25-1Bh√§drpad": "‡§™‡•Ç‡§∞‡•ç‡§µ‡§≠‡§æ‡§¶‡•ç‡§∞‡§™‡§¶", "26-2Bh√§drpad": "‡§â‡§§‡•ç‡§§‡§∞‡§≠‡§æ‡§¶‡•ç‡§∞‡§™‡§¶", "27-Revati": "‡§∞‡•á‡§µ‡§§‡•Ä" };
  if(i === 16 && nakshatraMap[val]) 
    val = nakshatraMap[val];

  // yog name mapping (if col5 has 01:Vi≈°kambh etc.)
  const yogMap = { "01:Vi≈°kambh": "‡§µ‡§ø‡§∑‡•ç‡§ï‡•Å‡§Æ‡•ç‡§≠", "02:Preeti": "‡§™‡•ç‡§∞‡•Ä‡§§‡§ø", "03:Ayu≈°m√§n": "‡§Ü‡§Ø‡•Å‡§∑‡•ç‡§Æ‡§æ‡§®", "04:Saubh√§gy": "‡§∏‡•å‡§≠‡§æ‡§ó‡•ç‡§Ø", "05:Shobhan": "‡§∂‡•ã‡§≠‡§®", "06:Atigand": "‡§Ö‡§§‡§ø‡§ó‡§£‡•ç‡§°", "07:Sukarman": "‡§∏‡•Å‡§ï‡§∞‡•ç‡§Æ‡§æ", "08:Dhriti": "‡§ß‡•É‡§§‡§ø", "09:Shoola": "‡§∂‡•Ç‡§≤", "10:Ganda": "‡§ó‡§£‡•ç‡§°", "11:Vriddhi": "‡§µ‡•É‡§¶‡•ç‡§ß‡§ø", "12:Dhruva": "‡§ß‡•ç‡§∞‡•Å‡§µ", "13:Vy√§gh√§t": "‡§µ‡•ç‡§Ø‡§æ‡§ò‡§æ‡§§", "14:Har≈°an": "‡§π‡§∞‡•ç‡§∑‡§£", "15:Vajra": "‡§µ‡§ú‡•ç‡§∞", "16:Siddhi": "‡§∏‡§ø‡§¶‡•ç‡§ß‡§ø", "17:Vyatip√§t": "‡§µ‡•ç‡§Ø‡§§‡•Ä‡§™‡§æ‡§§", "18:Variy√§n": "‡§µ‡§∞‡•Ä‡§Ø‡§æ‡§®‡•ç", "19:Parigha": "‡§™‡§∞‡§ø‡§ò", "20:Shiva": "‡§∂‡§ø‡§µ", "21:Siddha": "‡§∏‡§ø‡§¶‡•ç‡§ß", "22:S√§dhy": "‡§∏‡§æ‡§ß‡•ç‡§Ø", "23:Shubha": "‡§∂‡•Å‡§≠", "24:Shukla": "‡§∂‡•Å‡§ï‡•ç‡§≤", "25:Brahma": "‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ", "26:Indra": "‡§á‡§®‡•ç‡§¶‡•ç‡§∞", "27:V√¶dhrti": "‡§µ‡•à‡§ß‡•É‡§§‡§ø"};
  if(i === 5 && yogMap[val]) 
  val = yogMap[val];

 // day name mapping (if col2 has Sun/Mon etc.)
  const karanMap = { "Bava": "‡§¨‡§µ", "B√§lav": "‡§¨‡§æ‡§≤‡§µ", "Kaulav": "‡§ï‡•å‡§≤‡§µ", "Taitil": "‡§§‡•à‡§§‡§ø‡§≤", "Gara": "‡§ó‡§∞", "Vanij": "‡§µ‡§£‡§ø‡§ú", "Vi≈°ti": "‡§µ‡§ø‡§∑‡•ç‡§ü‡§ø *(‡§≠‡§¶‡•ç‡§∞‡§æ)*", "Shakun": "‡§∂‡§ï‡•Å‡§®‡§ø", "Chatu≈°": "‡§ö‡§§‡•Å‡§∑‡•ç‡§™‡§æ‡§¶", "N√§ga": "‡§®‡§æ‡§ó", "Kimstu": "‡§ï‡§ø‡§∏‡•ç‡§§‡•Å‡§ò‡•ç‡§®" };
  if(i === 7 && karanMap[val]) 
  val = karanMap[val];


//Roman to Devnagri mapping samapta

    // ‚úÖ Step 1: Check if this is column 13 (index 12)
  if (i === 13 && String(val).trim() === "0") {
    val = "‡§Ö‡§π‡•ã‡§∞‡§æ‡§§‡•ç‡§∞"; // Replace directly
  }

  // ‚úÖ Step 2: Handle time formatting logic for other columns
  else

    if(typeof val==="string" && /^\d{2,}:\d{2}(:\d{2})?$/.test(val.trim())){
      // Already formatted time
    }else if(!isNaN(val)&&val!==""){
      const num=parseFloat(val);
      if(num>=0 && num<2 && i !== 3) val=excelTimeToHMS(num);
    }


   // const varName=name.replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_]/g,"");
    const varName = "col"+i;
    window[varName]=val;

    
    out+=`<b>${name}:</b> <span id="${varName}">${val}</span><br>`;
    document.getElementById("test").innerText = window.col3;

  }
  
  resDiv.innerHTML=out;
}
</script>


<!-- START: Graha Chakra Enhancer (append this BEFORE </body>) -->
<style>
  /* Enhancer styles (isolated) */
  #grahaEnhancerControls{margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  #grahaChartWrap{margin-top:12px;border-radius:10px;padding:10px;background:#fff;border:1px solid #eee}
  #grahaCanvas{width:100%;height:auto;display:block}
  #grahaTooltip{position:absolute;pointer-events:none;background:rgba(0,0,0,0.85);color:#fff;padding:6px 8px;border-radius:6px;font-size:13px;display:none;z-index:9999}
  .graha-btn{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:#007bff;color:#fff;cursor:pointer}
  .graha-small{font-size:13px;color:#666}
</style>

<div id="grahaEnhancerControls">
  <label class="graha-small">Graha Chart:</label>
  <select id="grahaStyle" class="graha-small">
    <option value="south">South (Wheel)</option>
    <option value="north">North (Square)</option>
  </select>
  <button id="grahaExport" class="graha-btn">Export PNG</button>
  <button id="grahaPrint" class="graha-btn">Print</button>
  <span class="graha-small" style="margin-left:8px;color:#444">(This enhancer uses your existing col17..col24 values.)</span>
</div>

<div id="grahaChartWrap">
  <canvas id="grahaCanvas" width="800" height="800" aria-label="Graha Chakra Canvas"></canvas>
  <div id="grahaTooltip"></div>
</div>

<script>
(function(){
  // --- safety: do not overwrite existing names ---
  if(window.__grahaEnhancerInstalled) return;
  window.__grahaEnhancerInstalled = true;

  // config: rashi names, colors, and planet mapping (col indices are as you set)
  const rashiNames = ['‡§Æ‡•á‡§∑','‡§µ‡•É‡§∑‡§≠','‡§Æ‡§ø‡§•‡•Å‡§®','‡§ï‡§∞‡•ç‡§ï','‡§∏‡§ø‡§Ç‡§π','‡§ï‡§®‡•ç‡§Ø‡§æ','‡§§‡•Å‡§≤‡§æ','‡§µ‡•É‡§∂‡•ç‡§ö‡§ø‡§ï','‡§ß‡§®‡•Å','‡§Æ‡§ï‡§∞','‡§ï‡•Å‡§Æ‡•ç‡§≠','‡§Æ‡•Ä‡§®'];
  const rashiColors = ['#ffd54f','#ffb74d','#ff8a65','#a1887f','#90a4ae','#b39ddb','#81c784','#4db6ac','#64b5f6','#4fc3f7','#aed581','#ffb74d'];

  const planets = [
    {label: '‡§∏‡•Ç‡§∞‡•ç‡§Ø', col:17, color:'#f44336'},
    {label: '‡§ö‡§®‡•ç‡§¶‡•ç‡§∞', col:18, color:'#90caf9'},
    {label: '‡§Æ‡§Ç‡§ó‡§≤', col:19, color:'#e57373'},
    {label: '‡§¨‡•Å‡§ß',   col:20, color:'#aed581'},
    {label: '‡§ó‡•Å‡§∞‡•Å',  col:21, color:'#ffeb3b'},
    {label: '‡§∂‡•Å‡§ï‡•ç‡§∞', col:22, color:'#f06292'},
    {label: '‡§∂‡§®‡§ø',  col:23, color:'#455a64'},
    {label: '‡§∞‡§æ‡§π‡•Å', col:24, color:'#6a1b9a'}
    // Ketu if present => col:25
  ];

  // helpers
  function getCol(i){ return Number(window['col'+i] ?? NaN); }
  function clamp360(d){ return ((d%360)+360)%360; }
  function formatDeg(d){ if(isNaN(d)) return ''; d = clamp360(d); const deg = Math.floor(d); const min = Math.floor((d-deg)*60); return deg + '¬∞' + (min ? (min + "‚Ä≤") : ''); }
  function hexToRGBA(hex,alpha){
    const c = hex.replace('#',''); const num = parseInt(c,16);
    const r=(num>>16)&255, g=(num>>8)&255, b=num&255;
    return `rgba(${r},${g},${b},${alpha})`;
  }

  // canvas & responsiveness
  const canvas = document.getElementById('grahaCanvas');
  const tooltip = document.getElementById('grahaTooltip');
  let ctx, size;

  function setup(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    // keep square based on width
    size = Math.max(320, Math.min(rect.width, 900));
    canvas.width = Math.round(size * dpr);
    canvas.height = Math.round(size * dpr);
    canvas.style.height = size + 'px';
    // keep css width 100%
    canvas.style.width = '100%';
    ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }

  // draw functions
  function drawWheel(){
    setup();
    ctx.clearRect(0,0,size,size);
    const cx = size/2, cy = size/2, R = size*0.42;

    // rashis: 12 segments
    for(let i=0;i<12;i++){
      const start = (i*30 - 90) * Math.PI/180;
      const end = ((i+1)*30 - 90) * Math.PI/180;
      ctx.beginPath();
      ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,R,start,end);
      ctx.closePath();
      ctx.fillStyle = hexToRGBA(rashiColors[i], 0.06);
      ctx.fill();
      ctx.strokeStyle = '#ddd';
      ctx.stroke();

      // label
      const mid = (start + end)/2;
      const tx = cx + (R + 30) * Math.cos(mid);
      const ty = cy + (R + 30) * Math.sin(mid);
      ctx.fillStyle = '#222';
      ctx.font = Math.max(12, Math.round(size*0.02)) + 'px Arial';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(rashiNames[i], tx, ty);
    }

    // outer boundary
    ctx.beginPath(); ctx.arc(cx,cy,R,0,Math.PI*2); ctx.strokeStyle = '#bbb'; ctx.stroke();

    // planets
    planets.forEach(p=>{
      const deg = getCol(p.col);
      if(isNaN(deg)) { p._pos = null; return; }
      const rad = (deg - 90) * Math.PI/180;
      const px = cx + R * Math.cos(rad);
      const py = cy + R * Math.sin(rad);
      // marker
      ctx.beginPath();
      ctx.fillStyle = p.color;
      ctx.strokeStyle = '#00000030';
      ctx.lineWidth = 0.5;
      ctx.arc(px,py, Math.max(6, size*0.008), 0, Math.PI*2);
      ctx.fill(); ctx.stroke();
      // label (small)
      ctx.font = Math.max(11, Math.round(size*0.014)) + 'px Arial';
      ctx.fillStyle = '#000';
      ctx.textAlign = 'left';
      ctx.fillText(p.label + ' ' + formatDeg(deg), px + Math.max(8, size*0.02), py + 4);
      p._pos = {x:px, y:py, deg:deg};
    });
  }

  function drawNorth(){
    setup();
    ctx.clearRect(0,0,size,size);
    const cx = size/2, cy = size/2;
    const box = Math.min(size*0.22, 150);
    // simplified north layout (12 boxes)
    const layout = [
      {x:cx-box/2,y:cy-box*1.6},{x:cx+box/2,y:cy-box*1.6},
      {x:cx-box*1.6,y:cy-box/2},{x:cx-box*1.6,y:cy+box/2},
      {x:cx-box/2,y:cy+box*1.6},{x:cx+box/2,y:cy+box*1.6},
      {x:cx+box*1.6,y:cy+box/2},{x:cx+box*1.6,y:cy-box/2},
      {x:cx-box/2,y:cy-box/2},{x:cx+box/2,y:cy-box/2},
      {x:cx-box/2,y:cy+box/2},{x:cx+box/2,y:cy+box/2}
    ];

    ctx.font = Math.max(12, Math.round(size*0.015)) + 'px Arial';
    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';

    for(let i=0;i<12;i++){
      const pos = layout[i];
      ctx.beginPath();
      ctx.rect(pos.x-box/2, pos.y-box/2, box, box);
      ctx.fillStyle = hexToRGBA(rashiColors[i], 0.06);
      ctx.fill();
      ctx.strokeStyle = '#ddd';
      ctx.stroke();
      ctx.fillStyle = '#111';
      ctx.fillText(rashiNames[i], pos.x, pos.y - (box*0.12));
    }

    // place planets into boxes by rashi index
    planets.forEach(p=>{
      const deg = getCol(p.col);
      if(isNaN(deg)) { p._pos = null; return; }
      const ridx = Math.floor(clamp360(deg) / 30) % 12;
      const pos = layout[ridx];
      // jitter
      const px = pos.x - box*0.22 + Math.random() * box * 0.44;
      const py = pos.y - box*0.02 + Math.random() * box * 0.4;
      ctx.beginPath(); ctx.fillStyle = p.color; ctx.arc(px,py, Math.max(6,size*0.0075), 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#000'; ctx.textAlign='left'; ctx.fillText(p.label + ' ' + formatDeg(deg), px + Math.max(10,size*0.02), py);
      p._pos = {x:px,y:py,deg:deg};
    });
  }

  // render dispatcher
  function render(){
    const style = (document.getElementById('grahaStyle') || {value:'south'}).value;
    if(!ctx) setup();
    if(style === 'north') drawNorth();
    else drawWheel();
  }

  // tooltip handling
  function handleTooltip(ev){
    if(!canvas || !canvas.getBoundingClientRect) return;
    const rect = canvas.getBoundingClientRect();
    const x = ev.clientX - rect.left;
    const y = ev.clientY - rect.top;
    let closest = null, dmin = 1e9;
    planets.forEach(p=>{ if(!p._pos) return; const dx = p._pos.x - x; const dy = p._pos.y - y; const d = Math.hypot(dx,dy); if(d < dmin){ dmin = d; closest = p; } });
    if(closest && dmin < Math.max(12, size*0.02)){
      tooltip.style.display = 'block';
      tooltip.style.left = (ev.pageX + 12) + 'px';
      tooltip.style.top = (ev.pageY + 12) + 'px';
      const rashiIdx = Math.floor(clamp360(closest._pos.deg) / 30) % 12;
      tooltip.innerHTML = '<strong>' + closest.label + '</strong><br>' + formatDeg(closest._pos.deg) + '<br>‡§∞‡§æ‡§∂‡§ø: ' + rashiNames[rashiIdx];
    } else {
      tooltip.style.display = 'none';
    }
  }

  // export & print
  function exportPNG(){
    try{
      const url = canvas.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url; a.download = 'graha_chakra.png';
      a.click();
    }catch(e){ console.error(e); alert('Export failed'); }
  }
  function doPrint(){ window.print(); }

  // Hook into existing searchData: wrap it so enhancer runs after your original searchData finishes.
  function installHook(){
    if(typeof window.searchData === 'function' && !window.__grahaEnhancerHooked){
      const original = window.searchData;
      window.searchData = function(...args){
        // call the original (this will populate window.colN and update result)
        const res = original.apply(this, args);
        // schedule render after a small delay so original DOM updates and variables are ready
        setTimeout(()=> {
          try{ render(); } catch(e){ console.error('GrahaEnhancer render error', e); }
        }, 50);
        return res;
      };
      window.__grahaEnhancerHooked = true;
    } else {
      // if searchData not ready yet, try again shortly
      setTimeout(installHook, 200);
    }
  }

  // events
  window.addEventListener('resize', function(){ setTimeout(render, 120); });
  canvas.addEventListener('mousemove', handleTooltip);
  canvas.addEventListener('mouseleave', ()=>{ tooltip.style.display='none'; });
  document.getElementById('grahaExport').addEventListener('click', exportPNG);
  document.getElementById('grahaPrint').addEventListener('click', doPrint);
  const styleSelect = document.getElementById('grahaStyle'); styleSelect && styleSelect.addEventListener('change', () => { render(); });

  // initial run: try to hook and draw (if data exists)
  installHook();

  // also allow manual draw if user wants: call renderFromEnhancer()
  window.renderFromEnhancer = function(){ try{ render(); }catch(e){console.error(e);} };

  // if page already had col values (user ran search before attaching), render now
  setTimeout(()=> {
    try{ render(); }catch(e){/* ignore */ }
  }, 300);

})();
</script>
<!-- END: Graha Chakra Enhancer -->


</body>
</html>
